{
  "entities": {
    "UserProfile": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "UserProfile",
      "type": "object",
      "description": "Represents a student's profile within the AquaPoints application.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the UserProfile entity."
        },
        "firstName": {
          "type": "string",
          "description": "The first name of the student."
        },
        "lastName": {
          "type": "string",
          "description": "The last name of the student."
        },
        "email": {
          "type": "string",
          "description": "The email address of the student.",
          "format": "email"
        },
        "studentId": {
          "type": "string",
          "description": "The unique student identifier from the school's system."
        },
        "hydroPoints": {
          "type": "number",
          "description": "The student's current Hydro-Point balance."
        },
        "dailyGoal": {
          "type": "number",
          "description": "The student's daily hydration goal in ml."
        }
      },
      "required": [
        "id",
        "firstName",
        "lastName",
        "email",
        "studentId",
        "hydroPoints",
        "dailyGoal"
      ]
    },
    "HydroStation": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "HydroStation",
      "type": "object",
      "description": "Represents a hydro station location within the school.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the HydroStation entity."
        },
        "name": {
          "type": "string",
          "description": "The name or identifier of the hydro station."
        },
        "latitude": {
          "type": "number",
          "description": "The latitude coordinate of the hydro station's location."
        },
        "longitude": {
          "type": "number",
          "description": "The longitude coordinate of the hydro station's location."
        }
      },
      "required": [
        "id",
        "name",
        "latitude",
        "longitude"
      ]
    },
    "HydrationChallenge": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "HydrationChallenge",
      "type": "object",
      "description": "Represents a hydration challenge presented to a student.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the HydrationChallenge entity."
        },
        "description": {
          "type": "string",
          "description": "A description of the hydration challenge."
        },
        "pointsAwarded": {
          "type": "number",
          "description": "The number of Hydro-Points awarded for completing the challenge."
        },
        "startDate": {
          "type": "string",
          "description": "The date and time the challenge starts.",
          "format": "date-time"
        },
        "endDate": {
          "type": "string",
          "description": "The date and time the challenge ends.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "description",
        "pointsAwarded",
        "startDate",
        "endDate"
      ]
    },
    "StudentChallenge": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "StudentChallenge",
      "type": "object",
      "description": "Represents a student's participation in a hydration challenge.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the StudentChallenge entity."
        },
        "userProfileId": {
          "type": "string",
          "description": "Reference to UserProfile. (Relationship: UserProfile 1:N StudentChallenge)"
        },
        "hydrationChallengeId": {
          "type": "string",
          "description": "Reference to HydrationChallenge. (Relationship: HydrationChallenge 1:N StudentChallenge)"
        },
        "completed": {
          "type": "boolean",
          "description": "Indicates whether the student has completed the challenge."
        },
        "completionDate": {
          "type": "string",
          "description": "The date and time the challenge was completed.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "userProfileId",
        "hydrationChallengeId",
        "completed"
      ]
    },
    "HydrationRecord": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "HydrationRecord",
      "type": "object",
      "description": "Represents a student's hydration record.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the HydrationRecord entity."
        },
        "userProfileId": {
          "type": "string",
          "description": "Reference to UserProfile. (Relationship: UserProfile 1:N HydrationRecord)"
        },
        "timestamp": {
          "type": "string",
          "description": "The date and time of the hydration event.",
          "format": "date-time"
        },
        "amount": {
          "type": "number",
          "description": "The amount of water consumed in ml."
        },
        "hydroStationId": {
          "type": "string",
          "description": "Reference to HydroStation. (Relationship: HydroStation 1:N HydrationRecord). Nullable if hydration occurred elsewhere."
        }
      },
      "required": [
        "id",
        "userProfileId",
        "timestamp",
        "amount"
      ]
    },
    "Admin": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Admin",
      "type": "object",
      "description": "Represents a school administrator.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Admin entity."
        },
        "firstName": {
          "type": "string",
          "description": "The first name of the administrator."
        },
        "lastName": {
          "type": "string",
          "description": "The last name of the administrator."
        },
        "email": {
          "type": "string",
          "description": "The email address of the administrator.",
          "format": "email"
        }
      },
      "required": [
        "id",
        "firstName",
        "lastName",
        "email"
      ]
    },
    "StationErrorLog": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "StationErrorLog",
      "type": "object",
      "description": "Represents errors logged by the Hydro-Stations.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the StationErrorLog entity."
        },
        "hydroStationId": {
          "type": "string",
          "description": "Reference to HydroStation. (Relationship: HydroStation 1:N StationErrorLog)"
        },
        "timestamp": {
          "type": "string",
          "description": "The date and time the error occurred.",
          "format": "date-time"
        },
        "message": {
          "type": "string",
          "description": "The error message."
        }
      },
      "required": [
        "id",
        "hydroStationId",
        "timestamp",
        "message"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/users/{userId}/profile",
        "definition": {
          "entityName": "UserProfile",
          "schema": {
            "$ref": "#/backend/entities/UserProfile"
          },
          "description": "Stores the profile information for each user. Only the user themselves can read and write their profile. Includes denormalized 'userId' from path for authorization independence.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier for the user."
            }
          ]
        }
      },
      {
        "path": "/hydro_stations/{hydroStationId}",
        "definition": {
          "entityName": "HydroStation",
          "schema": {
            "$ref": "#/backend/entities/HydroStation"
          },
          "description": "Stores information about the hydro stations. Read access can be granted to all authenticated users. Write access is restricted to admins.",
          "params": [
            {
              "name": "hydroStationId",
              "description": "The unique identifier for the hydro station."
            }
          ]
        }
      },
      {
        "path": "/hydration_challenges/{hydrationChallengeId}",
        "definition": {
          "entityName": "HydrationChallenge",
          "schema": {
            "$ref": "#/backend/entities/HydrationChallenge"
          },
          "description": "Stores information about hydration challenges. Read access can be granted to all authenticated users. Write access is restricted to admins.",
          "params": [
            {
              "name": "hydrationChallengeId",
              "description": "The unique identifier for the hydration challenge."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/student_challenges/{studentChallengeId}",
        "definition": {
          "entityName": "StudentChallenge",
          "schema": {
            "$ref": "#/backend/entities/StudentChallenge"
          },
          "description": "Stores information about student participation in challenges. Only the user themselves can read and write their challenges. Includes denormalized 'userId' from path for authorization independence.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier for the user."
            },
            {
              "name": "studentChallengeId",
              "description": "The unique identifier for the student challenge."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/hydration_records/{hydrationRecordId}",
        "definition": {
          "entityName": "HydrationRecord",
          "schema": {
            "$ref": "#/backend/entities/HydrationRecord"
          },
          "description": "Stores hydration records for each user. Only the user themselves can read and write their hydration records. Includes denormalized 'userId' from path for authorization independence.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier for the user."
            },
            {
              "name": "hydrationRecordId",
              "description": "The unique identifier for the hydration record."
            }
          ]
        }
      },
      {
        "path": "/roles_admin/{userId}",
        "definition": {
          "entityName": "Admin",
          "schema": {
            "$ref": "#/backend/entities/Admin"
          },
          "description": "Indicates that a user has admin privileges. The existence of a document in this collection grants admin rights. Includes denormalized 'userId' from path for authorization independence.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier for the admin user."
            }
          ]
        }
      },
      {
        "path": "/hydro_stations/{hydroStationId}/error_logs/{errorLogId}",
        "definition": {
          "entityName": "StationErrorLog",
          "schema": {
            "$ref": "#/backend/entities/StationErrorLog"
          },
          "description": "Stores error logs for each hydro station.  Admins have read and write access. Includes denormalized 'hydroStationId' from path for authorization independence.",
          "params": [
            {
              "name": "hydroStationId",
              "description": "The unique identifier for the hydro station."
            },
            {
              "name": "errorLogId",
              "description": "The unique identifier for the error log."
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore structure is designed to support the AquaPoints application's core features, focusing on student profiles, hydration tracking, challenges, and admin functionalities. Key design principles are Authorization Independence, DBAC (Database-Based Access Control), and Structural Segregation. We leverage path-based ownership for user-related data and a dedicated collection for admin roles to simplify security rules.\n\n**Authorization Independence:**\n*   Student-owned data (HydrationRecords, StudentChallenges) is nested under `/users/{userId}`. This enables straightforward security rules based on `request.auth.uid` without requiring `get()` calls to parent documents.\n*   There are no denormalized fields for authorization since all authorization is based on direct ownership (path-based or existence checks).\n\n**Structural Segregation:**\n*   Each collection hosts data with similar access requirements. For instance, student profiles are stored under `/users/{userId}/profile` for private access, while hydration stations are stored in the `/hydro_stations` collection with separate access rules. HydrationChallenges are stored in the `/hydration_challenges` collection.\n*   Admin status is managed via the existence of a document in `/roles_admin/{userId}`, enabling simple existence-based authorization rules.\n\n**QAPs (Rules are not Filters):**\n*   The segregation of data based on ownership and roles ensures that listing operations are secure. For example, listing hydration records under `/users/{userId}/hydration_records` is secure because the rule can simply check if `request.auth.uid == userId`.\n*   The `/hydro_stations` and `/hydration_challenges` collections would have security rules to allow read access to all authenticated users, preventing over-fetching or the need to filter on the client-side.\n\n**Invariants:**\n*   Timestamps in HydrationRecords are automatically generated by the server (`FieldValue.serverTimestamp()`) to ensure integrity.\n*   Ownership is enforced through path-based security rules, preventing unauthorized modification of user data.\n\n**Error Handling:**\nThe error `FirebaseError: Firebase: Error (auth/configuration-not-found)` usually indicates a problem with the Firebase configuration in your Next.js application. This happens when the Firebase SDK is initialized without proper configuration, is not available in the client-side code, or is being accessed incorrectly. The `src/lib/auth.ts (20:28)` file should be checked and the Firebase config revalidated."
  }
}